{% extends "base.html" %}

{% block title %}Start Drive{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Live Drive Detection</h2>
                <span class="badge bg-primary" id="connection-status">Ready</span>
            </div>
            <div class="card-body">
                <div class="video-container position-relative mb-4" style="min-height: 480px; background-color: #000;">
                    <img id="video-feed" class="w-100 h-100 object-fit-contain" style="display: none;" alt="Live video feed">
                    <video id="local-video" class="w-100 h-100 object-fit-contain" style="display: none;" autoplay muted></video>
                    <div id="status" class="position-absolute top-50 start-50 translate-middle text-center text-white">
                        <i class="bi bi-camera-video fs-1 mb-2 d-block"></i>
                        <span class="fs-5">Click "Allow Camera Access" to begin</span>
                    </div>
                    <div id="spinner" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                        <p class="text-white mt-3">Loading YOLO model...</p>
                    </div>
                    <div id="detection-stats" class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-75 text-white" style="display: none;">
                        <div class="row">
                            <div class="col-4">
                                <i class="bi bi-traffic-light"></i> Traffic Lights: <span id="light-count">0</span>
                            </div>
                            <div class="col-4">
                                <i class="bi bi-person"></i> Pedestrians: <span id="person-count">0</span>
                            </div>
                            <div class="col-4">
                                <i class="bi bi-signpost-2"></i> Lane Markings: <span id="lane-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="permissionBtn" class="btn btn-outline-primary btn-lg me-2">
                        <i class="bi bi-camera"></i> Allow Camera Access
                    </button>
                    <button id="startBtn" class="btn btn-primary btn-lg me-2" disabled>
                        <i class="bi bi-play-fill"></i> Start Detection
                    </button>
                    <button id="stopBtn" class="btn btn-danger btn-lg" disabled>
                        <i class="bi bi-stop-fill"></i> Stop Detection
                    </button>
                </div>
                <div id="alerts" class="mt-4">
                    <!-- Alerts will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const videoFeed = document.getElementById('video-feed');
        const localVideo = document.getElementById('local-video');
        const permissionBtn = document.getElementById('permissionBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const alerts = document.getElementById('alerts');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const detectionStats = document.getElementById('detection-stats');
        const connectionStatus = document.getElementById('connection-status');
        let isStreaming = false;
        let statsUpdateInterval;
        let localStream = null;
        let hasPermission = false;
        let detectionCount = {
            red: 0,
            yellow: 0,
            green: 0,
            person: 0,
            lane: 0
        };

        // Check if browser supports getUserMedia
        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        if (!hasGetUserMedia) {
            addAlert('Your browser does not support camera access. Please use a modern browser like Chrome, Firefox, or Edge.', 'danger');
            permissionBtn.disabled = true;
        }

        function updateDetectionStats() {
            // Update the UI with current counts
            document.getElementById('light-count').textContent = detectionCount.red + detectionCount.yellow + detectionCount.green;
            document.getElementById('person-count').textContent = detectionCount.person;
            document.getElementById('lane-count').textContent = detectionCount.lane;
            
            // Reset counts for next update
            Object.keys(detectionCount).forEach(key => detectionCount[key] = 0);
        }

        // Listen for detection events from server
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'detection') {
                // Update detection counts
                event.data.detections.forEach(det => {
                    if (det.label in detectionCount) {
                        detectionCount[det.label]++;
                    }
                });
            }
        });

        permissionBtn.addEventListener('click', async function() {
            try {
                connectionStatus.textContent = 'Requesting permission...';
                connectionStatus.className = 'badge bg-warning';
                
                // Request camera permission
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Prefer rear camera if available
                    } 
                });
                
                // Show local video preview
                localVideo.srcObject = localStream;
                localVideo.style.display = 'block';
                status.style.display = 'none';
                
                // Update UI
                hasPermission = true;
                permissionBtn.disabled = true;
                startBtn.disabled = false;
                connectionStatus.textContent = 'Camera Ready';
                connectionStatus.className = 'badge bg-success';
                
                addAlert('Camera access granted! You can now start detection.', 'success');
            } catch (error) {
                console.error('Error accessing camera:', error);
                connectionStatus.textContent = 'Permission Denied';
                connectionStatus.className = 'badge bg-danger';
                addAlert('Camera permission denied. Please allow camera access and try again.', 'danger');
            }
        });

        startBtn.addEventListener('click', async function() {
            if (!isStreaming && hasPermission) {
                await startStream();
            } else if (!hasPermission) {
                addAlert('Please allow camera access first.', 'warning');
            }
        });

        stopBtn.addEventListener('click', async function() {
            if (isStreaming) {
                await stopStream();
            }
        });

        async function startStream() {
            try {
                // Don't stop the local video - we'll switch to server-processed feed instead
                localVideo.style.display = 'none';
                
                // Show loading state
                spinner.style.display = 'block';
                connectionStatus.textContent = 'Loading YOLO...';
                connectionStatus.className = 'badge bg-info';
                
                // Start the video feed from server (with AI processing)
                videoFeed.src = "{{ url_for('video_feed') }}?" + new Date().getTime(); // Add timestamp to prevent caching
                videoFeed.style.display = 'block';
                
                // Update UI state
                startBtn.disabled = true;
                stopBtn.disabled = false;
                isStreaming = true;
                
                // Handle video load
                videoFeed.onload = function() {
                    spinner.style.display = 'none';
                    detectionStats.style.display = 'block';
                    statsUpdateInterval = setInterval(updateDetectionStats, 1000);
                    connectionStatus.textContent = 'Live Detection';
                    connectionStatus.className = 'badge bg-success';
                    addAlert('YOLO model loaded! Detecting traffic lights, pedestrians, and lane markings...', 'success');
                };
                
                // Handle video error with retry mechanism
                let retryCount = 0;
                videoFeed.onerror = function() {
                    if (retryCount < 3) {
                        retryCount++;
                        console.error(`Failed to load video feed, retrying (${retryCount}/3)...`);
                        connectionStatus.textContent = `Reconnecting... (${retryCount}/3)`;
                        connectionStatus.className = 'badge bg-warning';
                        
                        setTimeout(() => {
                            if (isStreaming) {
                                videoFeed.src = "{{ url_for('video_feed') }}?" + new Date().getTime();
                            }
                        }, 2000);
                    } else {
                        // After retries, fall back to local camera
                        console.error('Failed to load AI-processed video feed, falling back to local camera');
                        connectionStatus.textContent = 'Using Local Camera';
                        connectionStatus.className = 'badge bg-secondary';
                        
                        // Hide the server feed and show the local camera again
                        videoFeed.style.display = 'none';
                        localVideo.style.display = 'block';
                        spinner.style.display = 'none';
                        
                        addAlert('Could not connect to AI detection service. Using local camera without detection.', 'warning');
                    }
                };
                
            } catch (error) {
                console.error('Error:', error);
                connectionStatus.textContent = 'Error';
                connectionStatus.className = 'badge bg-danger';
                addAlert('Failed to start detection. Please try again.', 'danger');
                
                // Fall back to local camera on error
                videoFeed.style.display = 'none';
                localVideo.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

        async function stopStream() {
            try {
                // Stop the server-side stream
                if (isStreaming) {
                    const response = await fetch("{{ url_for('stop_video') }}");
                    if (!response.ok) throw new Error('Failed to stop video feed');
                    
                    clearInterval(statsUpdateInterval);
                }
                
                // Reset UI
                connectionStatus.textContent = 'Ready';
                connectionStatus.className = 'badge bg-primary';
                videoFeed.src = '';
                videoFeed.style.display = 'none';
                
                // Show local camera again
                if (localStream && localStream.active) {
                    localVideo.style.display = 'block';
                } else {
                    status.style.display = 'block';
                    status.innerHTML = '<i class="bi bi-camera-video fs-1 mb-2 d-block"></i><span class="fs-5">Click "Allow Camera Access" to begin</span>';
                }
                
                // Reset buttons
                permissionBtn.disabled = localStream && localStream.active;
                startBtn.disabled = !hasPermission;
                stopBtn.disabled = true;
                isStreaming = false;
                detectionStats.style.display = 'none';
                spinner.style.display = 'none';
                
                addAlert('Detection stopped', 'info');
                
            } catch (error) {
                console.error('Error:', error);
                connectionStatus.textContent = 'Error';
                connectionStatus.className = 'badge bg-danger';
                addAlert('Error stopping detection: ' + error.message, 'warning');
            }
        }

        function addAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alerts.insertBefore(alertDiv, alerts.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode === alerts) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 5000);
        }

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (isStreaming) {
                fetch("{{ url_for('stop_video') }}");
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isStreaming) {
                stopStream();
            }
        });
    });
</script>
{% endblock %} 