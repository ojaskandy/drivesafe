{% extends "base.html" %}

{% block title %}Start Drive{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mb-4">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Camera Feed</h3>
                    <span id="connection-status" class="badge bg-secondary">Initializing</span>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="video-container" class="ratio ratio-16x9">
                        <video id="camera-feed" class="w-100" autoplay playsinline></video>
                        <canvas id="overlay-canvas" class="position-absolute top-0 start-0 w-100 h-100" style="display: none;"></canvas>
                    </div>
                    <div id="detection-overlay" class="position-absolute top-0 start-0 w-100 h-100" style="display: none;">
                        <img id="processed-image" class="w-100 h-100" style="object-fit: cover;" />
                    </div>
                </div>
                <div class="card-footer">
                    <div id="status-message" class="alert alert-info mb-3">
                        Camera not started. Click "Start Camera" to begin.
                    </div>
                    <div class="d-flex gap-2">
                        <button id="start-camera" class="btn btn-primary">
                            <i class="bi bi-camera-video"></i> Start Camera
                        </button>
                        <button id="start-detection" class="btn btn-success" disabled>
                            <i class="bi bi-play-circle"></i> Start Detection
                        </button>
                        <button id="stop-detection" class="btn btn-danger" disabled>
                            <i class="bi bi-stop-circle"></i> Stop Detection
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Detection Statistics</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 id="detection-status">No detections yet</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Traffic Light</th>
                                    <th>Count</th>
                                    <th>Current</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-danger me-1">Red</span>
                                        Red Light
                                    </td>
                                    <td id="red-count">0</td>
                                    <td id="red-current">0</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-warning me-1">Yellow</span>
                                        Yellow Light
                                    </td>
                                    <td id="yellow-count">0</td>
                                    <td id="yellow-current">0</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-success me-1">Green</span>
                                        Green Light
                                    </td>
                                    <td id="green-count">0</td>
                                    <td id="green-current">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button id="reset-stats" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset Stats
                    </button>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header">
                    <h3 class="mb-0">Model Information</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Processing Time:</h6>
                        <div id="processing-time">0 ms</div>
                    </div>
                    <div class="mb-3">
                        <h6>FPS:</h6>
                        <div id="fps">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM elements
        const startCameraBtn = document.getElementById('start-camera');
        const startDetectionBtn = document.getElementById('start-detection');
        const stopDetectionBtn = document.getElementById('stop-detection');
        const resetStatsBtn = document.getElementById('reset-stats');
        const statusMessage = document.getElementById('status-message');
        const connectionStatus = document.getElementById('connection-status');
        const videoElement = document.getElementById('camera-feed');
        const videoContainer = document.getElementById('video-container');
        const detectionOverlay = document.getElementById('detection-overlay');
        const processedImage = document.getElementById('processed-image');
        const detectionStatus = document.getElementById('detection-status');
        const processingTime = document.getElementById('processing-time');
        const fps = document.getElementById('fps');
        
        // Statistics elements
        const redCount = document.getElementById('red-count');
        const yellowCount = document.getElementById('yellow-count');
        const greenCount = document.getElementById('green-count');
        const redCurrent = document.getElementById('red-current');
        const yellowCurrent = document.getElementById('yellow-current');
        const greenCurrent = document.getElementById('green-current');
        
        // Variables
        let stream = null;
        let isDetecting = false;
        let canvasContext = null;
        let canvasElement = null;
        let lastProcessingTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let processingIntervalId = null;
        
        // Process a frame from the camera
        function processFrame() {
            if (!isDetecting || !stream) return;
            
            const startTime = performance.now();
            
            try {
                // Draw the current video frame to the canvas
                canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                
                // Get the image data from the canvas
                const imageData = canvasElement.toDataURL('image/jpeg', 0.8);
                
                // Send the image data to the server for processing
                fetch('/process_frame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error processing frame:', data.error);
                            statusMessage.textContent = `Error: ${data.error}`;
                            statusMessage.className = 'alert alert-danger mb-3';
                            return;
                        }
                        
                        // Display the processed image
                        processedImage.src = data.processed_image;
                        
                        // Update detection status
                        detectionStatus.textContent = data.detection_status;
                        
                        // Update stats
                        if (data.detections) {
                            redCount.textContent = data.detections.red;
                            yellowCount.textContent = data.detections.yellow;
                            greenCount.textContent = data.detections.green;
                        }
                        
                        // Update current detections
                        if (data.current_detections) {
                            redCurrent.textContent = data.current_detections.red;
                            yellowCurrent.textContent = data.current_detections.yellow;
                            greenCurrent.textContent = data.current_detections.green;
                            
                            // Set status message based on current detections
                            if (data.current_detections.red > 0) {
                                statusMessage.textContent = 'RED LIGHT DETECTED! Please stop.';
                                statusMessage.className = 'alert alert-danger mb-3';
                            } else if (data.current_detections.yellow > 0) {
                                statusMessage.textContent = 'YELLOW LIGHT DETECTED! Proceed with caution.';
                                statusMessage.className = 'alert alert-warning mb-3';
                            } else if (data.current_detections.green > 0) {
                                statusMessage.textContent = 'GREEN LIGHT DETECTED! Safe to proceed.';
                                statusMessage.className = 'alert alert-success mb-3';
                            } else {
                                statusMessage.textContent = 'No traffic lights detected in current frame.';
                                statusMessage.className = 'alert alert-info mb-3';
                            }
                        }
                        
                        // Calculate and display processing time
                        const endTime = performance.now();
                        lastProcessingTime = endTime - startTime;
                        processingTime.textContent = `${Math.round(lastProcessingTime)} ms`;
                        
                        // Update FPS counter
                        frameCount++;
                        const now = Date.now();
                        const elapsed = now - lastFpsUpdate;
                        if (elapsed >= 1000) {  // Update FPS every second
                            fps.textContent = Math.round((frameCount * 1000) / elapsed);
                            frameCount = 0;
                            lastFpsUpdate = now;
                        }
                    })
                    .catch(error => {
                        console.error('Error processing frame:', error);
                        statusMessage.textContent = `Network error: ${error.message}`;
                        statusMessage.className = 'alert alert-danger mb-3';
                    });
            } catch (error) {
                console.error('Error capturing frame:', error);
                statusMessage.textContent = `Error capturing frame: ${error.message}`;
                statusMessage.className = 'alert alert-danger mb-3';
            }
        }
        
        // Start camera
        startCameraBtn.addEventListener('click', async () => {
            try {
                connectionStatus.textContent = 'Requesting permission...';
                connectionStatus.className = 'badge bg-warning';
                
                // Request camera permission
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment'  // Use rear camera if available
                    }
                });
                
                // Set up video element
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                
                // Set up canvas for frame capture
                canvasElement = document.getElementById('overlay-canvas');
                canvasElement.width = 640;
                canvasElement.height = 480;
                canvasContext = canvasElement.getContext('2d');
                
                // Update UI
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
                statusMessage.textContent = 'Camera is running. Click "Start Detection" to begin processing.';
                statusMessage.className = 'alert alert-info mb-3';
                startCameraBtn.disabled = true;
                startDetectionBtn.disabled = false;
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                connectionStatus.textContent = 'Error';
                connectionStatus.className = 'badge bg-danger';
                statusMessage.textContent = `Error accessing camera: ${error.message}. Please ensure you've granted camera permissions.`;
                statusMessage.className = 'alert alert-danger mb-3';
            }
        });
        
        // Start detection
        startDetectionBtn.addEventListener('click', () => {
            startDetection();
        });
        
        function startDetection() {
            isDetecting = true;
            detectionOverlay.style.display = 'block';
            statusMessage.textContent = 'Starting detection...';
            statusMessage.className = 'alert alert-info mb-3';
            startDetectionBtn.disabled = true;
            stopDetectionBtn.disabled = false;
            
            // Process frames at a reasonable interval
            processingIntervalId = setInterval(processFrame, 100);  // Process ~10 frames per second
            
            // Process the first frame immediately
            processFrame();
        }
        
        // Stop detection
        stopDetectionBtn.addEventListener('click', () => {
            isDetecting = false;
            clearInterval(processingIntervalId);
            detectionOverlay.style.display = 'none';
            statusMessage.textContent = 'Detection stopped. Camera is still running.';
            statusMessage.className = 'alert alert-info mb-3';
            startDetectionBtn.disabled = false;
            stopDetectionBtn.disabled = true;
        });
        
        // Reset stats
        resetStatsBtn.addEventListener('click', () => {
            fetch('/reset_stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    redCount.textContent = '0';
                    yellowCount.textContent = '0';
                    greenCount.textContent = '0';
                    redCurrent.textContent = '0';
                    yellowCurrent.textContent = '0';
                    greenCurrent.textContent = '0';
                    detectionStatus.textContent = 'No detections yet';
                })
                .catch(error => {
                    console.error('Error resetting stats:', error);
                });
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            clearInterval(processingIntervalId);
        });
    });
</script>
{% endblock %} 