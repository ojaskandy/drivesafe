{% extends "base.html" %}

{% block title %}Start Drive{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Live Camera Feed</h3>
                    <span id="connection-status" class="badge bg-secondary">Initializing</span>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="video-container" class="ratio ratio-16x9">
                        <video id="camera-feed" class="w-100" autoplay playsinline></video>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header">
                    <h3 class="mb-0">Detection View</h3>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="detection-container" class="ratio ratio-16x9">
                        <div id="detection-overlay" class="w-100 h-100" style="display: none;">
                            <img id="processed-image" class="w-100 h-100" style="object-fit: cover;" />
                        </div>
                        <div id="loading-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50" style="display: none;">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div id="status-message" class="alert alert-info mb-3">
                        Camera not started. Click "Start Camera" to begin.
                    </div>
                    <div class="d-flex gap-2">
                        <button id="start-camera" class="btn btn-primary">
                            <i class="bi bi-camera-video"></i> Start Camera
                        </button>
                        <button id="start-detection" class="btn btn-success" disabled>
                            <i class="bi bi-play-circle"></i> Start Detection
                        </button>
                        <button id="stop-detection" class="btn btn-danger" disabled>
                            <i class="bi bi-stop-circle"></i> Stop Detection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Detection Statistics</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 id="detection-status">No detections yet</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Traffic Light</th>
                                    <th>Count</th>
                                    <th>Current</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-danger me-1">Red</span>
                                        Red Light
                                    </td>
                                    <td id="red-count">0</td>
                                    <td id="red-current">0</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-warning me-1">Yellow</span>
                                        Yellow Light
                                    </td>
                                    <td id="yellow-count">0</td>
                                    <td id="yellow-current">0</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge rounded-pill bg-success me-1">Green</span>
                                        Green Light
                                    </td>
                                    <td id="green-count">0</td>
                                    <td id="green-current">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button id="reset-stats" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset Stats
                    </button>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header">
                    <h3 class="mb-0">Model Information</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Processing Time:</h6>
                        <div id="processing-time">0 ms</div>
                    </div>
                    <div class="mb-3">
                        <h6>FPS:</h6>
                        <div id="fps">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM elements
        const startCameraBtn = document.getElementById('start-camera');
        const startDetectionBtn = document.getElementById('start-detection');
        const stopDetectionBtn = document.getElementById('stop-detection');
        const resetStatsBtn = document.getElementById('reset-stats');
        const statusMessage = document.getElementById('status-message');
        const connectionStatus = document.getElementById('connection-status');
        const videoElement = document.getElementById('camera-feed');
        const detectionOverlay = document.getElementById('detection-overlay');
        const processedImage = document.getElementById('processed-image');
        const loadingOverlay = document.getElementById('loading-overlay');
        const detectionStatus = document.getElementById('detection-status');
        const processingTime = document.getElementById('processing-time');
        const fps = document.getElementById('fps');
        
        // Statistics elements
        const redCount = document.getElementById('red-count');
        const yellowCount = document.getElementById('yellow-count');
        const greenCount = document.getElementById('green-count');
        const redCurrent = document.getElementById('red-current');
        const yellowCurrent = document.getElementById('yellow-current');
        const greenCurrent = document.getElementById('green-current');
        
        // Variables
        let stream = null;
        let isDetecting = false;
        let processingFrame = false;
        let lastProcessingTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let processingIntervalId = null;
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // Process a frame from the camera
        async function processFrame() {
            if (!isDetecting || !stream || processingFrame) return;
            
            processingFrame = true;
            const startTime = performance.now();
            
            try {
                // Create a temporary canvas to capture the current frame
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = videoElement.videoWidth;
                tempCanvas.height = videoElement.videoHeight;
                const tempContext = tempCanvas.getContext('2d');
                tempContext.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Get the image data from the canvas
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
                
                // Show loading overlay if processing takes too long
                const loadingTimeout = setTimeout(() => {
                    loadingOverlay.style.display = 'flex';
                }, 500);
                
                // Send the image data to the server for processing
                const response = await fetch('/process_frame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });
                
                clearTimeout(loadingTimeout);
                loadingOverlay.style.display = 'none';
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Reset retry count on successful processing
                retryCount = 0;
                
                // Display the processed image
                processedImage.src = data.processed_image;
                detectionOverlay.style.display = 'block';
                
                // Update detection status
                detectionStatus.textContent = data.detection_status;
                
                // Update stats
                if (data.detections) {
                    redCount.textContent = data.detections.red;
                    yellowCount.textContent = data.detections.yellow;
                    greenCount.textContent = data.detections.green;
                }
                
                // Update current detections
                if (data.current_detections) {
                    redCurrent.textContent = data.current_detections.red;
                    yellowCurrent.textContent = data.current_detections.yellow;
                    greenCurrent.textContent = data.current_detections.green;
                    
                    // Set status message based on current detections
                    if (data.current_detections.red > 0) {
                        statusMessage.textContent = 'RED LIGHT DETECTED! Please stop.';
                        statusMessage.className = 'alert alert-danger mb-3';
                    } else if (data.current_detections.yellow > 0) {
                        statusMessage.textContent = 'YELLOW LIGHT DETECTED! Proceed with caution.';
                        statusMessage.className = 'alert alert-warning mb-3';
                    } else if (data.current_detections.green > 0) {
                        statusMessage.textContent = 'GREEN LIGHT DETECTED! Safe to proceed.';
                        statusMessage.className = 'alert alert-success mb-3';
                    } else {
                        statusMessage.textContent = 'No traffic lights detected in current frame.';
                        statusMessage.className = 'alert alert-info mb-3';
                    }
                }
                
                // Calculate and display processing time
                const endTime = performance.now();
                lastProcessingTime = endTime - startTime;
                processingTime.textContent = `${Math.round(lastProcessingTime)} ms`;
                
                // Update FPS counter
                frameCount++;
                const now = Date.now();
                const elapsed = now - lastFpsUpdate;
                if (elapsed >= 1000) {
                    fps.textContent = Math.round((frameCount * 1000) / elapsed);
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
                
            } catch (error) {
                console.error('Error processing frame:', error);
                retryCount++;
                
                if (retryCount >= MAX_RETRIES) {
                    isDetecting = false;
                    stopDetectionBtn.click();
                    statusMessage.textContent = `Detection stopped due to errors: ${error.message}`;
                    statusMessage.className = 'alert alert-danger mb-3';
                } else {
                    statusMessage.textContent = `Error processing frame (retry ${retryCount}/${MAX_RETRIES}): ${error.message}`;
                    statusMessage.className = 'alert alert-warning mb-3';
                }
            } finally {
                processingFrame = false;
                loadingOverlay.style.display = 'none';
            }
        }
        
        // Start camera with error handling and retries
        async function startCamera(retryCount = 0) {
            const MAX_RETRIES = 3;
            try {
                connectionStatus.textContent = 'Requesting permission...';
                connectionStatus.className = 'badge bg-warning';
                
                // Request camera permission with constraints
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                });
                
                // Set up video element
                videoElement.srcObject = stream;
                await videoElement.play();
                
                // Update UI
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
                statusMessage.textContent = 'Camera started. Click "Start Detection" when ready.';
                statusMessage.className = 'alert alert-success mb-3';
                startCameraBtn.disabled = true;
                startDetectionBtn.disabled = false;
                
            } catch (error) {
                console.error('Error starting camera:', error);
                
                if (retryCount < MAX_RETRIES) {
                    statusMessage.textContent = `Retrying camera start (${retryCount + 1}/${MAX_RETRIES})...`;
                    statusMessage.className = 'alert alert-warning mb-3';
                    setTimeout(() => startCamera(retryCount + 1), 1000);
                } else {
                    connectionStatus.textContent = 'Error';
                    connectionStatus.className = 'badge bg-danger';
                    statusMessage.textContent = `Failed to start camera: ${error.message}`;
                    statusMessage.className = 'alert alert-danger mb-3';
                }
            }
        }
        
        // Event listeners
        startCameraBtn.addEventListener('click', () => startCamera());
        
        startDetectionBtn.addEventListener('click', () => {
            isDetecting = true;
            startDetectionBtn.disabled = true;
            stopDetectionBtn.disabled = false;
            statusMessage.textContent = 'Starting detection...';
            statusMessage.className = 'alert alert-info mb-3';
            detectionOverlay.style.display = 'block';
            
            // Start processing frames
            processingIntervalId = setInterval(processFrame, 100);
        });
        
        stopDetectionBtn.addEventListener('click', () => {
            isDetecting = false;
            clearInterval(processingIntervalId);
            startDetectionBtn.disabled = false;
            stopDetectionBtn.disabled = true;
            detectionOverlay.style.display = 'none';
            loadingOverlay.style.display = 'none';
            statusMessage.textContent = 'Detection stopped. Click "Start Detection" to resume.';
            statusMessage.className = 'alert alert-info mb-3';
        });
        
        resetStatsBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/reset_stats', { method: 'POST' });
                if (!response.ok) throw new Error('Failed to reset stats');
                
                // Reset all counters
                redCount.textContent = '0';
                yellowCount.textContent = '0';
                greenCount.textContent = '0';
                redCurrent.textContent = '0';
                yellowCurrent.textContent = '0';
                greenCurrent.textContent = '0';
                
                statusMessage.textContent = 'Statistics reset successfully.';
                statusMessage.className = 'alert alert-success mb-3';
            } catch (error) {
                console.error('Error resetting stats:', error);
                statusMessage.textContent = `Failed to reset stats: ${error.message}`;
                statusMessage.className = 'alert alert-danger mb-3';
            }
        });
    });
</script>
{% endblock %} 